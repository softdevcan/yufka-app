{% extends "base.html" %}

{% block title %}Stok Y√∂netimi - Yufka Takip{% endblock %}

{% block content %}
<h2>Stok Y√∂netimi</h2>

<!-- Mevcut Stok Durumu -->
<div class="form-section">
    <h2>Mevcut Stok</h2>
    {% if materials %}
    <div class="data-table">
        <table>
            <thead>
                <tr>
                    <th>Malzeme</th>
                    <th class="text-right">Stok</th>
                    <th class="text-right">Min. Seviye</th>
                    <th>Durum</th>
                </tr>
            </thead>
            <tbody>
                {% for m in materials %}
                <tr>
                    <td><strong>{{ m['name'] }}</strong></td>
                    <td class="text-right">{{ "%.2f"|format(m['stock_quantity']) }} {{ m['unit'] }}</td>
                    <td class="text-right">{{ "%.2f"|format(m['min_stock_level']) }} {{ m['unit'] }}</td>
                    <td>
                        {% if m['min_stock_level'] > 0 and m['stock_quantity'] <= m['min_stock_level'] %}
                        <span class="stock-warning">‚ö†Ô∏è D√º≈ü√ºk</span>
                        {% elif m['stock_quantity'] <= 0 %}
                        <span class="stock-danger">‚ùå T√ºkendi</span>
                        {% else %}
                        <span class="stock-ok">‚úì Yeterli</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="icon">üßæ</div>
        <p>Hen√ºz malzeme eklenmemi≈ü. <a href="/materials">Malzeme ekleyin</a></p>
    </div>
    {% endif %}
</div>

<!-- Stok Giri≈üi -->
<div class="form-section">
    <h2>Stok Giri≈üi (Malzeme Alƒ±mƒ±)</h2>
    <form method="post" action="/stock/add">
        <div class="form-row">
            <label for="material_id">
                Malzeme
                <select id="material_id" name="material_id" required>
                    <option value="">Se√ßiniz...</option>
                    {% for m in materials %}
                    <option value="{{ m['id'] }}">{{ m['name'] }} ({{ m['unit'] }})</option>
                    {% endfor %}
                </select>
            </label>

            <label for="quantity">
                Miktar
                <input type="number" id="quantity" name="quantity" min="0.01" step="0.01" required inputmode="decimal">
            </label>
        </div>

        <label for="notes">
            Not (Opsiyonel)
            <input type="text" id="notes" name="notes" placeholder="√∂rn: Firma X'den alƒ±ndƒ±">
        </label>

        <button type="submit">Stok Ekle</button>
    </form>
</div>

<!-- Stok D√ºzeltme -->
<div class="form-section">
    <h2>Stok D√ºzeltme (Sayƒ±m Sonrasƒ±)</h2>
    <form method="post" action="/stock/adjust">
        <div class="form-row">
            <label for="adjust_material_id">
                Malzeme
                <select id="adjust_material_id" name="material_id" required>
                    <option value="">Se√ßiniz...</option>
                    {% for m in materials %}
                    <option value="{{ m['id'] }}">{{ m['name'] }} (Mevcut: {{ "%.2f"|format(m['stock_quantity']) }} {{ m['unit'] }})</option>
                    {% endfor %}
                </select>
            </label>

            <label for="new_quantity">
                Yeni Miktar
                <input type="number" id="new_quantity" name="new_quantity" min="0" step="0.01" required inputmode="decimal">
            </label>
        </div>

        <label for="adjust_notes">
            D√ºzeltme Sebebi
            <input type="text" id="adjust_notes" name="notes" placeholder="√∂rn: Sayƒ±m sonucu d√ºzeltme">
        </label>

        <button type="submit" class="secondary">Stok D√ºzelt</button>
    </form>
</div>

<!-- Son Hareketler -->
<h3>Son Stok Hareketleri</h3>

{% if movements %}
<div class="data-table">
    <table>
        <thead>
            <tr>
                <th>Tarih</th>
                <th>Malzeme</th>
                <th>ƒ∞≈ülem</th>
                <th class="text-right">Miktar</th>
                <th>Not</th>
            </tr>
        </thead>
        <tbody>
            {% for mov in movements %}
            <tr>
                <td>{{ mov['created_at'] | date }}</td>
                <td>{{ mov['material_name'] }}</td>
                <td>{{ movement_types.get(mov['movement_type'], mov['movement_type']) }}</td>
                <td class="text-right {% if mov['quantity'] > 0 %}text-success{% else %}text-danger{% endif %}">
                    {% if mov['quantity'] > 0 %}+{% endif %}{{ "%.2f"|format(mov['quantity']) }} {{ mov['material_unit'] }}
                </td>
                <td>{{ mov['notes'] or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="empty-state">
    <div class="icon">üìã</div>
    <p>Hen√ºz stok hareketi yok</p>
</div>
{% endif %}
{% endblock %}
