{% extends "base.html" %}

{% block title %}Stok Yönetimi - Yufka Takip{% endblock %}

{% block content %}
<h2>Stok Yönetimi</h2>

<!-- Ürün Stokları -->
<div class="form-section">
    <h2>Ürün Stokları</h2>
    <div class="data-table">
        <table>
            <thead>
                <tr>
                    <th>Ürün</th>
                    <th class="text-right">Fiyat</th>
                    <th class="text-right">Stok</th>
                    <th>Durum</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for ps in product_stocks %}
                <tr>
                    <td><strong>{{ product_types.get(ps['product_type'], ps['product_type']) }}</strong></td>
                    <td class="text-right">
                        <form method="post" action="/stock/product/price"
                            style="display: inline-flex; align-items: center; gap: 0.5rem;">
                            <input type="hidden" name="product_type" value="{{ ps['product_type'] }}">
                            <input type="number" name="price" value="{{ ps['price'] }}" min="0" step="0.01"
                                style="width: 80px; margin: 0;" required> ₺
                            <button type="submit" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Güncelle</button>
                        </form>
                    </td>
                    <td class="text-right">{{ ps['stock_quantity'] }} adet</td>
                    <td>
                        {% if ps['min_stock_level'] > 0 and ps['stock_quantity'] <= ps['min_stock_level'] %} <span
                            class="stock-warning">⚠️ Düşük</span>
                            {% elif ps['stock_quantity'] <= 0 %} <span class="stock-danger">❌ Tükendi</span>
                                {% else %}
                                <span class="stock-ok">✓ Yeterli</span>
                                {% endif %}
                    </td>
                    <td></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Hazır Ürün Alımı (Mantı, Kadayıf) -->
<div class="form-section">
    <h2>Hazır Ürün Alımı (Mantı, Kadayıf)</h2>
    <form method="post" action="/stock/product/add">
        <div class="form-row">
            <label for="product_type">
                Ürün
                <select id="product_type" name="product_type" required>
                    <option value="">Seçiniz...</option>
                    {% for key, value in purchased_products.items() %}
                    <option value="{{ key }}">{{ value }}</option>
                    {% endfor %}
                </select>
            </label>

            <label for="product_quantity">
                Adet
                <input type="number" id="product_quantity" name="quantity" min="1" required inputmode="numeric">
            </label>
        </div>

        <label for="product_notes">
            Not (Opsiyonel)
            <input type="text" id="product_notes" name="notes" placeholder="örn: X firmasından alındı">
        </label>

        <button type="submit">Ürün Stok Ekle</button>
    </form>
</div>

<!-- Hammadde Stokları -->
<div class="form-section">
    <h2>Hammadde Stokları</h2>
    {% if materials %}
    <div class="data-table">
        <table>
            <thead>
                <tr>
                    <th>Malzeme</th>
                    <th class="text-right">Stok</th>
                    <th class="text-right">Min.</th>
                    <th>Durum</th>
                </tr>
            </thead>
            <tbody>
                {% for m in materials %}
                <tr>
                    <td><strong>{{ m['name'] }}</strong></td>
                    <td class="text-right">{{ "%.1f"|format(m['stock_quantity']) }} {{ m['unit'] }}</td>
                    <td class="text-right">{{ "%.1f"|format(m['min_stock_level']) }} {{ m['unit'] }}</td>
                    <td>
                        {% if m['min_stock_level'] > 0 and m['stock_quantity'] <= m['min_stock_level'] %} <span
                            class="stock-warning">⚠️ Düşük</span>
                            {% elif m['stock_quantity'] <= 0 %} <span class="stock-danger">❌ Tükendi</span>
                                {% else %}
                                <span class="stock-ok">✓ Yeterli</span>
                                {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <p>Henüz malzeme eklenmemiş. <a href="/materials">Malzeme ekleyin</a></p>
    </div>
    {% endif %}
</div>

<!-- Hammadde Stok Girişi -->
<div class="form-section">
    <h2>Hammadde Stok Girişi</h2>
    <form method="post" action="/stock/add">
        <div class="form-row">
            <label for="material_id">
                Malzeme
                <select id="material_id" name="material_id" required>
                    <option value="">Seçiniz...</option>
                    {% for m in materials %}
                    <option value="{{ m['id'] }}">{{ m['name'] }} ({{ m['unit'] }})</option>
                    {% endfor %}
                </select>
            </label>

            <label for="quantity">
                Miktar
                <input type="number" id="quantity" name="quantity" min="0.01" step="0.01" required inputmode="decimal">
            </label>
        </div>

        <label for="notes">
            Not (Opsiyonel)
            <input type="text" id="notes" name="notes" placeholder="örn: Firma X'den alındı">
        </label>

        <button type="submit">Hammadde Ekle</button>
    </form>
</div>

<!-- Son Ürün Stok Hareketleri -->
<h3>Son Ürün Stok Hareketleri</h3>

{% if product_movements %}
<div class="data-table">
    <table>
        <thead>
            <tr>
                <th>Tarih</th>
                <th>Ürün</th>
                <th>İşlem</th>
                <th class="text-right">Miktar</th>
                <th>Not</th>
            </tr>
        </thead>
        <tbody>
            {% for mov in product_movements %}
            <tr>
                <td>{{ mov['created_at'] | date }}</td>
                <td>{{ product_types.get(mov['product_type'], mov['product_type']) }}</td>
                <td>{{ movement_types.get(mov['movement_type'], mov['movement_type']) }}</td>
                <td class="text-right {% if mov['quantity'] > 0 %}text-success{% else %}text-danger{% endif %}">
                    {% if mov['quantity'] > 0 %}+{% endif %}{{ mov['quantity'] }} adet
                </td>
                <td>{{ mov['notes'] or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="empty-state">
    <p>Henüz ürün stok hareketi yok</p>
</div>
{% endif %}

<!-- Son Hammadde Stok Hareketleri -->
<h3>Son Hammadde Stok Hareketleri</h3>

{% if material_movements %}
<div class="data-table">
    <table>
        <thead>
            <tr>
                <th>Tarih</th>
                <th>Malzeme</th>
                <th>İşlem</th>
                <th class="text-right">Miktar</th>
                <th>Not</th>
            </tr>
        </thead>
        <tbody>
            {% for mov in material_movements %}
            <tr>
                <td>{{ mov['created_at'] | date }}</td>
                <td>{{ mov['material_name'] }}</td>
                <td>{{ movement_types.get(mov['movement_type'], mov['movement_type']) }}</td>
                <td class="text-right {% if mov['quantity'] > 0 %}text-success{% else %}text-danger{% endif %}">
                    {% if mov['quantity'] > 0 %}+{% endif %}{{ "%.1f"|format(mov['quantity']) }} {{ mov['material_unit']
                    }}
                </td>
                <td>{{ mov['notes'] or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="empty-state">
    <p>Henüz hammadde stok hareketi yok</p>
</div>
{% endif %}
{% endblock %}